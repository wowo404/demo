<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>sample</title>
    <script src="https://cdn.bootcss.com/fetch/2.0.4/fetch.js"></script>
</head>

<body>
    <button id="login">登录</button>
    <button id='btn'>下载</button>
    <span id='status'></span>
</body>
<script>
//登录
var loginUrl = "http://127.0.0.1:9011/admin/user/login";
document.getElementById('login').onclick = function() {
    fetch(loginUrl, {
        method: 'POST',
        credentials: 'include',
        headers: {
            'content-type': 'application/json'
        },
        body: '{"account":"admin","password":"lghf888888"}'
    }).then(res => {
        console.log(res.headers.get('Set-Cookie'));
        console.log(res.headers.get('content-type'));
    });
};

//下载
var url = "http://127.0.0.1:9011/admin/order/orderExcel";

let order = {
    orderNos: "328712769350275072"
}

document.getElementById('btn').onclick = function() {
    document.getElementById('status').innerHTML = '下载中';
    fetch(url, {
        method: 'POST',
        credentials: 'include',
        headers: {
            'content-type': 'application/x-www-form-urlencoded'
        },
        body: "orderNos=328712769350275072"
    }).then(res => {
        if (res.status != 200) {
            alert(res.statusText);
        } else {
            //判断content-type
            let contentType = res.headers.get('content-type');
            if (contentType.includes('application/json')) {
                handleJSONResponse(res);
            } else if (contentType.includes('text/html')) {
                handleTextResponse(res);
            } else if (contentType.includes('application/vnd.ms-excel')) {
                handlerStreamResponse(res);
            }
        }
    });
};

function handleJSONResponse(response) {
    response.json()
        .then(json => {
            if (response.ok) {
                console.log(json);
            } else {
                return Promise.reject(Object.assign({}, json, {
                    status: response.status,
                    statusText: response.statusText
                }))
            }
        })
}

function handleTextResponse(response) {
    response.text()
        .then(text => {
            if (response.ok) {
                console.log(text);
            } else {
                return Promise.reject({
                    status: response.status,
                    statusText: response.statusText,
                    err: text
                })
            }
        })
}

function handlerStreamResponse(response) {
    response.blob().then(blob => {
        let a = document.createElement('a');
        let url = window.URL.createObjectURL(blob);
        let disposition = response.headers.get('content-disposition');
        let fileName = decodeURI(disposition.split('=')[1]);
        a.href = url;
        a.download = fileName;
        a.click();
        window.URL.revokeObjectURL(url);
        document.getElementById('status').innerHTML = '下载完成';
    })
}
</script>

</html>